# AI 女友项目执行书 (AI Girlfriend Project Execution Plan)

> **文档版本**: 2.1  
> **最后更新**: 2025-12-30  
> **项目状态**: 🟢 Phase 2 完成，Phase 3 进行中

---

## 1. 项目概况 (Project Overview)

### 1.1 基本信息
| 字段 | 内容 |
|------|------|
| **项目名称** | Project AI-Girlfriend (暂定名) |
| **项目目标** | 开发一个具备高度拟人化性格、能够进行自然语音和文字交互、拥有长期记忆的情感陪伴型 AI 智能体 |
| **核心价值** | 情感陪伴、个性化定制、随时响应、持久记忆 |
| **目标用户** | 需要情感陪伴、希望拥有定制化 AI 伴侣的用户 |

### 1.2 项目亮点
- 🎭 **真人化性格**: 基于详细的人设提示词，具备傲娇、温柔、害羞等多种情绪表达
- 💾 **持久记忆**: 对话历史和好感度自动保存，重启不丢失
- 🎨 **精美界面**: 二次元风格 UI，支持明暗主题切换
- 🎤 **语音交互**: 支持 TTS 语音合成和 ASR 语音识别
- 💕 **好感度系统**: 根据互动质量动态调整好感度
- 🔔 **主动交互**: 支持早晚问候、主动关心、任务提醒等智能主动消息

---

## 2. 当前进度总览 (Progress Overview)

```
Phase 1: MVP 原型           [████████████████████] 100% ✅
Phase 2: 语音与情感         [████████████████████] 100% ✅
Phase 3: 视觉与优化         [██████░░░░░░░░░░░░░░] 30%  🔄
```

### 已完成功能清单
| 功能 | 状态 | 说明 |
|------|------|------|
| 多轮对话 | ✅ | 基于 OpenAI 兼容 API 的自然语言交流 |
| 性格设定 | ✅ | 可配置的 AI 人设 (小爱)，包含详细人物设定 |
| 基础记忆 | ✅ | 记住对话上下文，支持向量 RAG 检索相关记忆 |
| 好感度系统 | ✅ | 动态好感度 (0-100)，影响 AI 说话风格 |
| 情绪识别 | ✅ | AI 返回情绪标签 (happy/shy/thinking/sleepy/sad/angry) |
| 持久化存储 | ✅ | 对话历史和状态自动保存到 JSON 文件 |
| 精美 UI | ✅ | Next.js + TailwindCSS 打造的二次元风格界面 |
| 主题切换 | ✅ | 暗色/亮色主题支持 |
| TTS 语音合成 | ✅ | 使用 OpenAI TTS API，nova 音色 |
| ASR 语音识别 | ✅ | 使用 Whisper API，支持中文 |
| 主动消息引擎 | ✅ | 支持早晚问候、想念消息、任务提醒等多种触发类型 |
| 任务管理 | ✅ | 简单的任务增删改查及到期提醒 |

---

## 3. 核心功能详解 (Core Features in Detail)

### 3.1 Phase 1: 基础功能 (MVP) ✅ 已完成

#### 3.1.1 多轮对话系统
```
用户消息 → [History Context] → [RAG Memory] → [LLM API] → AI 回复
                                                              ↓
                                          解析 Metadata (emotion, affinity_change)
                                                              ↓
                                              更新好感度 → 保存状态
```

**技术实现**:
- 使用 OpenAI SDK 调用 Chat Completion API
- 支持多种模型切换 (GPT-4, GPT-3.5, DeepSeek 等)
- 对话历史内存保留，支持上下文理解

**API 接口**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/chat` | POST | 发送消息获取回复 |
| `/history` | GET | 获取对话历史 |
| `/history` | DELETE | 清空对话历史 |

#### 3.1.2 性格与人设系统
**默认人设 - 小爱 (Xiao Ai)**:
- **外表**: 粉色长发，温柔的紫色眼睛，穿着露肩毛衣
- **性格**: 温柔体贴，偶尔害羞，有时候也会有点小傲娇或者调皮
- **说话方式**: 使用可爱的语气助词（呢、呀、哦、～）和颜文字

**可配置项**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `system_prompt` | 完整人设提示词 | 小爱人设 |
| `nickname` | AI 对用户的称呼 | "亲爱的" |

**API 接口**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/system_prompt` | GET | 获取当前人设 |
| `/system_prompt` | POST | 更新人设提示词 |

#### 3.1.3 记忆系统
**实现架构**:
```
Memory.js
├── 基于关键词的简单 RAG 检索
├── JSON 文件持久化存储 (memory_db/memory.json)
├── 自动保存每轮对话
└── 支持检索最相关的 N 条记忆
```

**记忆检索算法**:
1. 将用户输入分词
2. 遍历所有记忆，计算关键词匹配得分
3. 返回得分最高的 Top N 条记忆作为上下文

**API 接口**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/memories` | GET | 获取所有记忆 |
| `/memories` | DELETE | 清空记忆 |

#### 3.1.4 好感度与情绪系统
**好感度机制**:
- 范围: 0-100
- 初始值: 35
- 变化规则:
  - 夸奖/关心: +1~3
  - 表白: +5
  - 粗鲁/谩骂: -1~5
  - 正常对话: 0~+1

**情绪类型**:
| 情绪 | 触发场景 |
|------|----------|
| `default` | 平静/微笑/默认 |
| `happy` | 开心/兴奋/大笑 |
| `shy` | 害羞/脸红/撒娇 |
| `thinking` | 思考/疑惑/好奇 |
| `sleepy` | 困倦/晚安 |

**元数据解析**:
AI 回复末尾会附带 `<metadata>` 标签，后端自动解析并更新状态。

---

### 3.2 Phase 2: 语音与情感 ✅ 已完成

#### 3.2.1 语音合成 (TTS) ✅ 已完成
**当前实现**:
- 使用 OpenAI TTS API
- 模型: `tts-1`
- 音色: `nova` (温柔女声)
- 输出: MP3 文件，存储于 `static/audio/`

**API 接口**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/audio/speak` | POST | 文字转语音 |

**后续优化方案**:
| 方案 | 特点 | 优先级 |
|------|------|--------|
| Edge-TTS | 免费、高质量微软语音 | ⭐⭐⭐ |
| GPT-SoVITS | 支持克隆任意音色 | ⭐⭐ |
| CosyVoice | 阿里开源，中文效果好 | ⭐⭐ |

#### 3.2.2 语音识别 (ASR) ✅ 已完成
**当前实现**:
- 使用 OpenAI Whisper API
- 模型: `whisper-1`
- 语言优化: 中文 (zh)

**API 接口**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/audio/transcribe` | POST | 语音转文字 (multipart/form-data) |

**后续优化方案**:
| 方案 | 特点 | 优先级 |
|------|------|--------|
| FunASR | 阿里开源，离线可用 | ⭐⭐⭐ |
| Whisper 本地部署 | 完全离线 | ⭐⭐ |

#### 3.2.3 记忆增强 (RAG) 🔄 待优化
**当前实现**: 基于简单关键词匹配

**计划升级**:
| 功能 | 说明 | 优先级 |
|------|------|--------|
| 向量相似度检索 | 使用 Embedding 模型计算语义相似度 | ⭐⭐⭐ |
| ChromaDB 集成 | 使用专业向量数据库 | ⭐⭐ |
| 记忆分类 | 区分事实记忆、情感记忆、偏好记忆 | ⭐⭐ |

---

### 3.3 Phase 3: 视觉与主动交互 (🔄 进行中)

#### 3.3.1 主动交互 (Active Interaction) ✅ 已完成 (核心功能)
**功能描述**: 
AI 不再只是被动回复，而是根据时间、事件和好感度主动发起对话。

**ProactiveEngine 实现细节**:
- **触发类型**:
  - `morning_greeting`: 早安问候 (8:00-8:05)
  - `night_greeting`: 晚安问候 (22:00-22:05)
  - `task_reminder`: 任务截止前 15 分钟提醒
  - `mood_check`: 下午/晚间情绪关怀
  - `miss_you`: 用户长时间(2h+)未活跃且好感度高时触发
  - `random_chat`: 随机闲聊，概率受好感度影响
  - `memory_share`: 偶尔分享过去的回忆

- **智能冷却与队列**:
  - 每种类型有独立冷却时间 (CD)
  - 消息优先级队列，重要消息优先发送
  - 每日消息上限控制，防止打扰

**新 API 接口**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/chat/proactive` | GET | 轮询主动消息 (前端定时调用) |
| `/tasks` | GET/POST | 任务管理 (用于触发提醒) |

#### 3.3.2 视觉形象 (Avatar) 📋 待开始
| 功能 | 说明 | 技术方案 |
|------|------|----------|
| 静态立绘 | 显示角色形象 | PNG/WebP 图片 |
| 表情切换 | 根据情绪切换表情 | 多套立绘预加载 |
| Live2D | 动态表情，眨眼、说话动画 | Cubism SDK + pixi-live2d |
| 口型同步 | 根据语音驱动嘴型 | 音频分析 + 动画映射 |

#### 3.3.3 多模态感知 📋 待开始
| 功能 | 说明 | 技术方案 |
|------|------|----------|
| 图片理解 | 用户发送图片，AI 能看懂 | GPT-4 Vision API |
| 表情分析 | 识别用户表情调整回复 | 表情识别 API |

---

## 4. 技术架构 (Technical Architecture)

### 4.1 系统架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend (Next.js)                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  ChatPage   │ │ TaskDialog  │ │ SettingsDialog│ │MemoryDialog│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
│                              ↓ HTTP API                          │
├─────────────────────────────────────────────────────────────────┤
│                        Backend (Node.js/Express)                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │AiGirlfriend │ │ProactiveEng │ │ TaskManager │ │ VoiceEngine │ │
│  │   (Core)    │ │   (Loop)    │ │    (DB)     │ │ (TTS/ASR)   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
│                              ↓                                   │
├─────────────────────────────────────────────────────────────────┤
│                        External Services                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ OpenAI API  │ │ Whisper API │ │   TTS API   │ │ Embedding   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 目录结构
```
ai-girlfriend/
├── 📄 PROJECT_PLAN.md          # 本计划书
├── 📄 start.bat                # 一键启动脚本 (Windows)
├── 📄 .env                     # 环境变量 (API Key)
├── 📁 memory_db/               # 持久化存储
│   ├── memory.json             # 对话记忆
│   ├── state.json              # 好感度、对话历史
│   └── tasks.json              # [NEW] 任务数据
│
├── 📁 backend-node/            # Node.js 后端
│   ├── package.json            # 依赖配置
│   ├── src/
│   │   ├── server.js           # Express 服务器入口
│   │   └── core/
│   │       ├── AiGirlfriend.js # AI 核心逻辑
│   │       ├── Memory.js       # 记忆系统
│   │       ├── Voice.js        # 语音引擎
│   │       ├── ProactiveEngine.js # [NEW] 主动消息引擎
│   │       └── TaskManager.js  # [NEW] 任务管理器
│   ├── static/audio/           # TTS 生成的音频文件
│   └── temp_uploads/           # ASR 临时上传文件
│
└── 📁 frontend/                # Next.js 前端
    ├── src/app/
        ├── page.tsx            # 主聊天页面 (含轮询逻辑)
        └── components/
            ├── CharacterPanel.tsx    # 角色面板
            ├── TaskDialog.tsx        # [NEW] 任务管理面板
            └── ...
```

### 4.3 技术栈详情 (新增)
- **前端**: Next.js 16 (App Router), Lucide React, Framer Motion
- **后端**: Express, Node.js 18+
- **主动交互**: `setInterval` 轮询机制 (前端) + 消息队列 (后端)

---

## 5. 开发路线图 (Development Roadmap)

### 5.1 Phase 1: MVP 原型 ✅ 已完成
| 任务 | 状态 | 说明 |
|------|------|------|
| 环境搭建 | ✅ | Node.js + Next.js 项目初始化 |
| 核心对话 | ✅ | 接入 OpenAI 兼容 API |
| UI 界面 | ✅ | 精美二次元聊天界面 |
| Prompt 调试 | ✅ | 完整的"小爱"人设提示词 |
| 好感度系统 | ✅ | 动态好感度 + 情绪解析 |
| 持久化 | ✅ | JSON 文件存储对话和状态 |
| 一键启动 | ✅ | start.bat 脚本 |

### 5.2 Phase 2: 语音与情感 ✅ 已完成
| 任务 | 状态 | 说明 |
|------|------|------|
| TTS 语音合成 | ✅ | OpenAI TTS API，支持独立 Key 配置 |
| ASR 语音识别 | ✅ | Whisper API，录音波形可视化 |
| 前端语音按钮 | ✅ | 消息播放、录音计时、自动发送 |
| 向量记忆 (RAG) | ✅ | OpenAI Embeddings 语义检索 |
| 情感分析优化 | ✅ | 5级好感度行为规则 + 7种情绪 |
| Edge-TTS 集成 | 📋 | 可选优化，待定 |

### 5.3 Phase 3: 视觉与优化 🔄 进行中
| 任务 | 状态 | 说明 |
|------|------|------|
| 主动消息引擎 | ✅ | 包含早晚安、任务提醒、情感关怀 |
| 任务管理系统 | ✅ | 简单的 CRUD 及提醒机制 |
| 前端轮询与通知 | ✅ | 支持浏览器通知和打字机效果 |
| 静态立绘 | 📋 | 待开始 |
| 表情切换 | 📋 | 待开始 |
| Live2D 集成 | 📋 | 待开始 |
| 图片理解 | 📋 | 待开始 |
| 打包部署 | 📋 | 待开始 |

**图例**: ✅ 已完成 | 🔄 进行中 | 📋 待开始

---

## 6. 资源需求 (Resources)
（保持不变）

---

## 7. 快速开始 (Quick Start)
（保持不变）

---

## 8. 配置说明 (Configuration)
（保持不变）

---

## 9. 常见问题 (FAQ)
（新增）
### Q6: 为什么没收到主动消息？
**A**: 
1. 检查前端页面是否保持打开状态。
2. 确认浏览器是否允许了通知权限。
3. 主动消息受好感度和冷却时间限制，不会频繁触发。

---

## 10. 后续优化计划 (Future Improvements)
（保持不变）

---
